<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniBabel - Parental Consent Verification</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css"
          rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#dc2626",
                        secondary: "#1a1a1a",
                        dark: "#0a0a0a",
                        accent: "#374151"
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif']
                    }
                }
            }
        };
    </script>
    <style>
        .upload-area {
            border: 2px dashed #374151;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #dc2626;
            background-color: rgba(220, 38, 38, 0.05);
        }
        .upload-area.drag-over {
            border-color: #dc2626;
            background-color: rgba(220, 38, 38, 0.1);
        }
    </style>
</head>
<body class="bg-dark text-white font-poppins">

<!-- Header -->
<div class="bg-secondary border-b border-gray-700 p-4">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-primary">UniBabel</h1>
            <span class="text-gray-400">‚Ä¢</span>
            <h2 class="text-xl font-semibold text-white">Parental Consent</h2>
        </div>
        <div class="text-sm text-gray-400">
            üõ°Ô∏è Child Safety Verification
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="max-w-4xl mx-auto p-6">

    <!-- Child Information -->
    <div class="bg-blue-900/30 border border-blue-500 rounded-lg p-6 mb-6">
        <div class="flex items-start space-x-4">
            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                <i class="ri-user-line text-white text-2xl"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold text-blue-300 mb-2">Account Request for Your Child</h3>
                <div class="space-y-1 text-blue-200">
                    <p><strong>Child's Name:</strong> <span id="child-name">Loading...</span></p>
                    <p><strong>Username:</strong> <span id="child-username">Loading...</span></p>
                    <p><strong>Age Group:</strong> <span id="child-age">13-17 years old</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Warning -->
    <div class="bg-red-900/30 border border-red-500 rounded-lg p-6 mb-6">
        <div class="flex items-start space-x-4">
            <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
                <i class="ri-error-warning-line text-white text-2xl"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold text-red-300 mb-2">‚ö†Ô∏è Identity Verification
                    Required</h3>
                <p class="text-red-200 mb-4">To protect children from predators, you must verify
                    your identity as the parent/guardian.</p>

                <div class="bg-red-800/50 rounded-lg p-4">
                    <h4 class="font-semibold text-red-300 mb-2">Why This Matters:</h4>
                    <ul class="space-y-1 text-red-200 text-sm">
                        <li>‚Ä¢ Prevents strangers from impersonating parents</li>
                        <li>‚Ä¢ Ensures only real guardians can authorize child accounts</li>
                        <li>‚Ä¢ Required by child safety laws (COPPA)</li>
                        <li>‚Ä¢ Protects your child from online predators</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Parent ID Verification Form -->
    <div class="bg-secondary rounded-xl p-6 mb-6">
        <h3 class="text-xl font-semibold text-white mb-6 flex items-center">
            <i class="ri-shield-check-line text-primary mr-3"></i>
            Parent/Guardian ID Verification
        </h3>

        <form id="parentVerificationForm" enctype="multipart/form-data">

            <!-- Step 1: Parent ID Upload -->
            <div class="mb-8">
                <h4 class="text-lg font-semibold text-white mb-3">Step 1: Upload Your Government
                    ID</h4>
                <p class="text-gray-400 text-sm mb-4">Driver's License, Passport, State ID, or
                    National ID Card</p>

                <div class="upload-area rounded-lg p-8 text-center cursor-pointer"
                     id="parentIdUploadArea">
                    <input type="file" id="parentIdDocument" name="parent_id_document"
                           accept="image/*" class="hidden">
                    <div id="parentIdUploadContent">
                        <i class="ri-id-card-line text-4xl text-gray-400 mb-3"></i>
                        <p class="text-white font-medium mb-1">Click to upload your ID</p>
                        <p class="text-gray-400 text-sm">JPG, PNG or JPEG (Max 10MB)</p>
                    </div>
                    <div id="parentIdPreview" class="hidden">
                        <img id="parentIdPreviewImg" class="max-w-full max-h-48 mx-auto rounded-lg">
                        <p class="text-green-400 mt-2">Parent ID uploaded ‚úì</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Parent Selfie -->
            <div class="mb-8">
                <h4 class="text-lg font-semibold text-white mb-3">Step 2: Take a Selfie</h4>
                <p class="text-gray-400 text-sm mb-4">Clear photo of your face to match with your
                    ID</p>

                <div class="upload-area rounded-lg p-8 text-center cursor-pointer"
                     id="parentSelfieUploadArea">
                    <input type="file" id="parentSelfie" name="parent_selfie" accept="image/*"
                           class="hidden">
                    <div id="parentSelfieUploadContent">
                        <i class="ri-camera-line text-4xl text-gray-400 mb-3"></i>
                        <p class="text-white font-medium mb-1">Click to upload your selfie</p>
                        <p class="text-gray-400 text-sm">JPG, PNG or JPEG (Max 5MB)</p>
                    </div>
                    <div id="parentSelfiePreview" class="hidden">
                        <img id="parentSelfiePreviewImg"
                             class="max-w-full max-h-48 mx-auto rounded-lg">
                        <p class="text-green-400 mt-2">Selfie uploaded ‚úì</p>
                    </div>
                </div>
            </div>

            <!-- Consent Checkbox -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <div class="flex items-start space-x-3">
                    <input type="checkbox" id="parentConsent" required
                           class="mt-1 w-5 h-5 text-primary">
                    <div>
                        <label for="parentConsent" class="text-white font-medium cursor-pointer">
                            I verify that I am the parent/legal guardian and give consent for my
                            child to use UniBabel
                        </label>
                        <div class="text-gray-400 text-sm mt-2">
                            <p>By checking this box, I confirm that:</p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>I am at least 18 years old</li>
                                <li>I am the legal parent/guardian of the child</li>
                                <li>I understand the child safety measures in place</li>
                                <li>I consent to my child using the platform with safety
                                    restrictions
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitVerification"
                    class="w-full bg-primary hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed px-6 py-4 rounded-lg font-semibold text-lg transition-colors flex items-center justify-center"
                    disabled>
                <i class="ri-shield-check-line mr-2"></i>
                Verify Identity & Approve Child Account
            </button>

        </form>
    </div>

    <!-- Processing Status -->
    <div id="processingStatus"
         class="hidden bg-yellow-900/30 border border-yellow-500 rounded-lg p-4 mb-6">
        <div class="flex items-center space-x-3">
            <div class="animate-spin w-5 h-5 border-2 border-yellow-400 border-t-transparent rounded-full"></div>
            <div>
                <h3 class="font-semibold text-yellow-300">Verifying Your Identity</h3>
                <p class="text-sm text-yellow-200">AI is processing your documents and verifying
                    parental status...</p>
            </div>
        </div>
    </div>

    <!-- Result -->
    <div id="verificationResult" class="hidden"></div>

</div>

<script>

// Global variables
let parentIdFile = null;
let parentSelfieFile = null;

// Get consent token from URL
const consentToken = window.location.pathname.split('/').pop();

// DOM elements
const parentIdUploadArea = document.getElementById('parentIdUploadArea');
const parentSelfieUploadArea = document.getElementById('parentSelfieUploadArea');
const parentIdDocument = document.getElementById('parentIdDocument');
const parentSelfie = document.getElementById('parentSelfie');
const submitBtn = document.getElementById('submitVerification');
const parentVerificationForm = document.getElementById('parentVerificationForm');

// Setup upload areas
setupUploadArea(parentIdUploadArea, parentIdDocument, 'parentId');
setupUploadArea(parentSelfieUploadArea, parentSelfie, 'parentSelfie');

// Load consent data
loadConsentData();

function setupUploadArea(uploadArea, fileInput, type) {
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(fileInput, type);
        }
    });
    
    fileInput.addEventListener('change', () => handleFileSelect(fileInput, type));
}

function handleFileSelect(fileInput, type) {
    const file = fileInput.files[0];
    if (!file) return;
    
    // Validate file
    if (!file.type.startsWith('image/')) {
        showNotification('Please select an image file', 'error');
        return;
    }
    
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        showNotification('File too large. Max size: 10MB', 'error');
        return;
    }
    
    // Store file
    if (type === 'parentId') {
        parentIdFile = file;
    } else {
        parentSelfieFile = file;
    }
    
    // Show preview
    showPreview(file, type);
    
    // Update submit button
    updateSubmitButton();
}

function showPreview(file, type) {
    const reader = new FileReader();
    reader.onload = (e) => {
        if (type === 'parentId') {
            document.getElementById('parentIdUploadContent').classList.add('hidden');
            document.getElementById('parentIdPreview').classList.remove('hidden');
            document.getElementById('parentIdPreviewImg').src = e.target.result;
        } else {
            document.getElementById('parentSelfieUploadContent').classList.add('hidden');
            document.getElementById('parentSelfiePreview').classList.remove('hidden');
            document.getElementById('parentSelfiePreviewImg').src = e.target.result;
        }
    };
    reader.readAsDataURL(file);
}

function updateSubmitButton() {
    const consentChecked = document.getElementById('parentConsent').checked;
    if (parentIdFile && parentSelfieFile && consentChecked) {
        submitBtn.disabled = false;
    }
}

// Handle consent checkbox
document.getElementById('parentConsent').addEventListener('change', updateSubmitButton);

async function loadConsentData() {
    try {
        const response = await fetch(`/api/parental-consent/${consentToken}/status`);
        const data = await response.json();
        
        if (data.status === 'pending') {
            document.getElementById('child-name').textContent = data.child_name;
            document.getElementById('child-username').textContent = data.child_username || 'Loading...';
        } else {
            showNotification('Consent request not found or expired', 'error');
        }
    } catch (error) {
        console.error('Error loading consent data:', error);
    }
}

// Form submission
parentVerificationForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!parentIdFile || !parentSelfieFile) {
        showNotification('Please upload both ID document and selfie', 'error');
        return;
    }
    
    // Show processing
    document.getElementById('processingStatus').classList.remove('hidden');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2"></div>Processing...';
    
    // Create form data
    const formData = new FormData();
    formData.append('parent_id_document', parentIdFile);
    formData.append('parent_selfie', parentSelfieFile);
    formData.append('consent_token', consentToken);
    
    try {
        const response = await fetch('/api/parental-consent/verify', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        // Hide processing
        document.getElementById('processingStatus').classList.add('hidden');
        
        if (result.success) {
            showVerificationResult('success', result);
        } else {
            showVerificationResult('error', result);
            resetSubmitButton();
        }
        
    } catch (error) {
        console.error('Verification error:', error);
        document.getElementById('processingStatus').classList.add('hidden');
        showNotification('Network error. Please try again.', 'error');
        resetSubmitButton();
    }
});

function showVerificationResult(type, result) {
    const resultDiv = document.getElementById('verificationResult');
    
    if (type === 'success') {
        resultDiv.innerHTML = `
            <div class="bg-green-900/30 border border-green-500 rounded-lg p-6">
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                        <i class="ri-check-line text-white text-2xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-green-300 mb-2">‚úÖ Child Account Approved!</h3>
                        <p class="text-green-200 mb-4">Your child's account has been successfully created with parental verification.</p>
                        
                        <div class="bg-green-800/30 rounded-lg p-4 mb-4">
                            <h4 class="font-medium text-green-300 mb-2">Account Details:</h4>
                            <div class="text-sm space-y-1">
                                <div>Child Username: <span class="font-medium">${result.username}</span></div>
                                <div>User Type: <span class="font-medium">Child (Protected)</span></div>
                                <div>Safety Level: <span class="font-medium">Maximum Protection</span></div>
                                <div>Parent Verified: <span class="font-medium">‚úì Yes</span></div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-800/30 rounded-lg p-4 mb-4">
                            <h4 class="font-medium text-blue-300 mb-2">üõ°Ô∏è Safety Features Active:</h4>
                            <ul class="text-sm text-blue-200 space-y-1">
                                <li>‚Ä¢ Kids-only chat rooms</li>
                                <li>‚Ä¢ 24/7 AI content moderation</li>
                                <li>‚Ä¢ Automatic profanity filtering</li>
                                <li>‚Ä¢ Weekly activity reports to you</li>
                                <li>‚Ä¢ No data collection from your child</li>
                                <li>‚Ä¢ Instant parent controls</li>
                            </ul>
                        </div>
                        
                        <p class="text-green-200 text-sm mb-4">
                            Your child can now safely use UniBabel. You'll receive weekly email reports about their activity.
                        </p>
                        
                        <div class="flex space-x-3">
                            <button onclick="window.close()" class="bg-primary hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition-colors">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        resultDiv.innerHTML = `
            <div class="bg-red-900/30 border border-red-500 rounded-lg p-6">
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
                        <i class="ri-close-line text-white text-2xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-red-300 mb-2">‚ùå Verification Failed</h3>
                        <p class="text-red-200 mb-4">${result.error}</p>
                        
                        <div class="flex space-x-3">
                            <button onclick="resetForm()" class="bg-primary hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition-colors">
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    resultDiv.classList.remove('hidden');
}

function resetForm() {
    parentIdFile = null;
    parentSelfieFile = null;
    
    document.getElementById('parentIdUploadContent').classList.remove('hidden');
    document.getElementById('parentIdPreview').classList.add('hidden');
    document.getElementById('parentSelfieUploadContent').classList.remove('hidden');
    document.getElementById('parentSelfiePreview').classList.add('hidden');
    
    parentVerificationForm.reset();
    resetSubmitButton();
    document.getElementById('verificationResult').classList.add('hidden');
}

function resetSubmitButton() {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="ri-shield-check-line mr-2"></i>Verify Identity & Approve Child Account';
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-semibold z-50 ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 
        'bg-blue-600'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>

</body>
</html>